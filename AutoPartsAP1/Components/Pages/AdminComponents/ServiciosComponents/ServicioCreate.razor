@page "/Servicio/Create"
@using Blazored.Toast.Services
@using AutoPartsAP1.Components.Models;
@using Microsoft.AspNetCore.Components.Forms
@inject ServiciosService servicioService
@inject NavigationManager navigationmanager
@inject IToastService itoastservice
@rendermode InteractiveServer
@attribute [Authorize]
@attribute [Authorize(Roles="Admin")]


<PageTitle>Crear Producto</PageTitle>
<EditForm Model="servicio" OnValidSubmit="Guardar" FormName="ServicioCreate">
    <DataAnnotationsValidator />
    <div class="container py-4">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-success">
                <i class="bi bi-plus-circle me-2"></i> Crear Nuevo Servicio
            </h2>
            <p class="text-muted">Completa los campos para añadir un nuevo servicio al registro.</p>
        </div>

        <div class="card shadow-sm rounded-4 border-0">
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-md-7">
                        <h5 class="mb-3 text-secondary">
                            <i class="bi bi-info-circle me-2"></i> Detalles del Servicio
                        </h5>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">ID del Servicio</label>
                                <InputNumber class="form-control" @bind-Value="servicio.ServicioId" readonly />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Nombre</label>
                                <InputText class="form-control" @bind-Value="servicio.Nombre" placeholder="Escribe el nombre del servicio" />
                                <ValidationMessage For="(() => servicio.Nombre)" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Descripción</label>
                                <InputTextArea class="form-control" @bind-Value="servicio.Descripcion" placeholder="Añade una descripción detallada" rows="3" />
                                <ValidationMessage For="(() => servicio.Descripcion)" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Monto (Precio)</label>
                                <InputNumber class="form-control" step="0.01" @bind-Value="servicio.Precio" placeholder="0.00" />
                                <ValidationMessage For="(() => servicio.Precio)" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5 d-flex flex-column align-items-center">
                        <h5 class="mb-3 text-secondary">
                            <i class="bi bi-image me-2"></i> Imagen del Servicio
                        </h5>
                        <div class="card p-3 w-100 rounded-4" style="border: 2px dashed #e9ecef; height: 100%;">
                            <div class="d-flex flex-column justify-content-center align-items-center h-100">
                                @if (servicio.ServicioImagen != null)
                                {
                                    <img src="data:image/png;base64,@Convert.ToBase64String(servicio.ServicioImagen)"
                                         class="img-fluid rounded-3 mb-3" alt="Imagen del servicio"
                                         style="max-height: 250px; object-fit: contain; max-width: 100%;" />
                                }
                                else
                                {
                                    <div class="text-center text-muted mb-3">
                                        <i class="bi bi-image-fill" style="font-size: 5rem;"></i>
                                        <p class="mt-2">No hay imagen seleccionada</p>
                                    </div>
                                }
                                <InputFile OnChange="SubirImagen" accept=".jpg,.jpeg,.png,.gif" class="form-control mt-auto" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer bg-light text-center py-3 rounded-bottom-4">
                <div class="btn-group" role="group">
                    <button type="reset" class="btn btn-primary d-flex align-items-center" @onclick="Nuevo">
                        <i class="bi bi-arrow-clockwise me-2"></i> Limpiar
                    </button>
                    <button type="submit" class="btn btn-success d-flex align-items-center">
                        <i class="bi bi-save me-2"></i> Guardar
                    </button>
                    <a href="/Servicios/Index" class="btn btn-secondary d-flex align-items-center">
                        <i class="bi bi-arrow-left me-2"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    private Servicios servicio { get; set; } = new Servicios();
    private IBrowserFile? selectedImageFile;

    public void Nuevo()
    {
        servicio = new Servicios();
        selectedImageFile = null;
    }

    private async Task SubirImagen(InputFileChangeEventArgs e)
    {
        selectedImageFile = e.File;

        if (selectedImageFile != null)
        {
            if (selectedImageFile.Size > 5 * 1024 * 1024)
            {
                itoastservice.ShowError("La imagen no debe exceder los 5MB.");
                selectedImageFile = null;
                servicio.ServicioImagen= null;
                return;
            }

            try
            {
                using var stream = new MemoryStream();
                await selectedImageFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);
                servicio.ServicioImagen = stream.ToArray();
            }
            catch (Exception ex)
            {
                itoastservice.ShowError($"Error al cargar la imagen: {ex.Message}");
                selectedImageFile = null;
                servicio.ServicioImagen= null;
            }
        }
        else
        {
            servicio.ServicioImagen= null;
        }
    }

    public async Task Guardar()
    {
        if (servicio == null)
        {
            itoastservice.ShowError("Error interno: El servicio es nulo.");
            return;
        }
        var guardo = await servicioService.GuardarServicio(servicio);

        if (guardo)
        {
            itoastservice.ShowSuccess("Servicio guardado correctamente");
            navigationmanager.NavigateTo("/Servicios/Index");
            Nuevo();
        }
        else
        {
            itoastservice.ShowError("Error al registrar el servicio");
        }
    }
}